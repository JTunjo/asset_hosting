<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tunjo Wishes WordCloud</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f2f7f3; 
      text-align: center; 
      padding: 20px; 
    }
    h1 { color: #2c6e49; }
    #counter { font-size: 1.2em; margin: 15px 0; color: #444; }
    #wordCloud {
      width: 100%;
      height: 600px; /* ðŸ”’ fixed height */
      max-width: 1000px;
      margin: auto;
    }
  </style>
</head>
<body>
  <h1>ðŸŒ± Nuestro deseo unido de un futuro sostenible</h1>
  <p id="counter">Cargando deseos...</p>
  <canvas id="wordCloud"></canvas>

  <script>
    let chartInstance = null; // store chart to destroy later

    async function loadData() {
      const sheetId = "1bATo8gpOfsV3_HgRbwnYnmteOFxh77sjqt2gpYkuuBk"; 
      const apiKey = "AIzaSyABzLxdigSjc8S2hii4bGv42XnTE_gNyzc"; 
      const range = "Sheet1!D2:D"; // D column = Wishes

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
      const response = await fetch(url);
      const data = await response.json();

      if (!data.values) return { words: [], total: 0 };

      const wishes = data.values.map(row => row[0]);
      const total = wishes.length;

      const words = wishes.join(" ").split(/\s+/);

      // Stopwords to filter out
      const stopwords = new Set(["quiero", "deseo", "sueÃ±o", "para"]);

      const counts = {};
      words.forEach(w => {
        const word = w.toLowerCase().replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±]/gi, "");
        if (word.length > 3 && !stopwords.has(word)) {
          counts[word] = (counts[word] || 0) + 1;
        }
      });

      return { 
        words: Object.entries(counts).map(([text, weight]) => ({ text, weight })), 
        total 
      };
    }

    function drawWordCloud(result) {
      const ctx = document.getElementById("wordCloud");

      // Destroy previous chart if exists
      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: "wordCloud",
        data: {
          labels: result.words.map(w => w.text),
          datasets: [{
            label: "Sustainable Wishes",
            data: result.words.map(w => w.weight),
          }]
        },
        options: {
          plugins: { legend: { display: false } }
        }
      });
    }

    loadData().then(result => {
      document.getElementById("counter").textContent = `âœ¨ Total de deseos hasta ahora: ${result.total}`;
      drawWordCloud(result);
    });
  </script>
</body>
</html>
